import pandas as pd
import numpy as np

def calc_monthly_inventory(
    annual_sales_volume_df: pd.DataFrame,
    id_df: pd.DataFrame,
    item_df: pd.DataFrame,
    plchange_df: pd.DataFrame,
) -> pd.DataFrame:
    """
    å¹´é–“è²©å£²é‡ãƒ»å“ç›®ãƒã‚¹ã‚¿ãƒ»ç¹å¿™åº¦ãƒã‚¹ã‚¿ãƒ»PLæ›ç®—ä¿‚æ•°ã‹ã‚‰ã€
    è­˜åˆ¥å­Ã—å¹´æœˆã”ã¨ã®è²©å£²æ•°é‡ãƒ»åœ¨åº«æ•°é‡(t)ãƒ»åœ¨åº«æ•°é‡(PL)ã‚’è¨ˆç®—ã™ã‚‹ã€‚
    """

    # 1) å¹´é–“è²©å£²é‡ã‚’ã€Œå¹´ã”ã¨ç¸¦æŒã¡ã€ã«å¤‰æ›
    year_cols = [c for c in annual_sales_volume_df.columns if c.endswith("å¹´")]

    sales_long = annual_sales_volume_df.melt(
        id_vars="è­˜åˆ¥å­",
        value_vars=year_cols,
        var_name="å¹´",
        value_name="å¹´é–“è²©å£²æ•°é‡",
    )

    # "2025å¹´" â†’ 2025 ï¼ˆæ•´æ•°ï¼‰
    sales_long["å¹´"] = sales_long["å¹´"].str.replace("å¹´", "", regex=False).astype(int)

    # 2) id_df ã¨ è­˜åˆ¥å­ ã§çµåˆï¼ˆå“åãƒ»åœ¨åº«ç¶­æŒæœˆæ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ä¸ï¼‰
    merged = sales_long.merge(id_df, on="è­˜åˆ¥å­", how="left")

    # 3) item_df ã¨ å“å ã§çµåˆï¼ˆæœˆãƒ»ç¹å¿™åº¦ã‚’ä»˜ä¸ï¼‰
    merged = merged.merge(item_df, on="å“å", how="left")

    # 4) å¹´æœˆåˆ—ã®ä½œæˆ
    # "1æœˆ" â†’ 1 ã«å¤‰æ›
    merged["æœˆ_num"] = (
        merged["æœˆ"]
        .astype(str)
        .str.replace("æœˆ", "", regex=False)
        .astype(int)
    )

    # å¹´æœˆã‚’ datetime ã«ã—ã¦ã‹ã‚‰ date ã«è½ã¨ã™ï¼ˆ2025-01-01 ã®å½¢ï¼‰
    merged["å¹´æœˆ"] = pd.to_datetime(
        merged["å¹´"].astype(str)
        + "-"
        + merged["æœˆ_num"].astype(str).str.zfill(2)
        + "-01"
    ).dt.date

    # 5) æ•°å€¤å‹ã«æƒãˆã‚‹ï¼ˆã“ã“å¤§äº‹ï¼‰
    numeric_cols = [
        "å¹´é–“è²©å£²æ•°é‡",
        "ç¹å¿™åº¦",
        "é€šå¸¸æœŸ_åœ¨åº«ç¶­æŒæœˆæ•°",
        "å‚™è“„æœŸ_åœ¨åº«ç¶­æŒæœˆæ•°",
    ]
    for col in numeric_cols:
        merged[col] = pd.to_numeric(merged[col], errors="coerce")

    # æœˆã‚ãŸã‚Šè²©å£²æ•°é‡ = å¹´é–“è²©å£²æ•°é‡ / 12
    merged["è²©å£²æ•°é‡"] = merged["å¹´é–“è²©å£²æ•°é‡"] / 12.0

    # 6) ç¹å¿™åº¦ã”ã¨ã®åœ¨åº«ç¶­æŒæœˆæ•°ã‚’è¨ˆç®—
    # ç¹å¿™åº¦: 1=é€šå¸¸æœŸ, 2=ä¸­é–“, 3=å‚™è“„MAX
    factor_map = {
        1: 0.0,   # é€šå¸¸æœŸ â†’ é€šå¸¸æœŸã®åœ¨åº«ç¶­æŒæœˆæ•°
        2: 0.5,   # ä¸­é–“ â†’ é€šå¸¸æœŸã¨å‚™è“„æœŸã®ä¸­é–“
        3: 1.0,   # å‚™è“„MAX â†’ å‚™è“„æœŸã®åœ¨åº«ç¶­æŒæœˆæ•°
    }

    merged["ç¹å¿™åº¦ä¿‚æ•°"] = merged["ç¹å¿™åº¦"].map(factor_map)

    # æƒ³å®šå¤–ï¼ˆNaNãªã©ï¼‰ã¯é€šå¸¸æœŸæ‰±ã„ï¼ˆ=ä¿‚æ•°0ï¼‰
    merged.loc[merged["ç¹å¿™åº¦ä¿‚æ•°"].isna(), "ç¹å¿™åº¦ä¿‚æ•°"] = 0.0

    # åœ¨åº«ç¶­æŒæœˆæ•° = é€šå¸¸æœŸ + (å‚™è“„æœŸ - é€šå¸¸æœŸ) * ä¿‚æ•°
    merged["åœ¨åº«ç¶­æŒæœˆæ•°"] = (
        merged["é€šå¸¸æœŸ_åœ¨åº«ç¶­æŒæœˆæ•°"]
        + (merged["å‚™è“„æœŸ_åœ¨åº«ç¶­æŒæœˆæ•°"] - merged["é€šå¸¸æœŸ_åœ¨åº«ç¶­æŒæœˆæ•°"])
        * merged["ç¹å¿™åº¦ä¿‚æ•°"]
    )

    # 7) åœ¨åº«æ•°é‡ = è²©å£²æ•°é‡ Ã— åœ¨åº«ç¶­æŒæœˆæ•°
    merged["åœ¨åº«æ•°é‡"] = merged["è²©å£²æ•°é‡"] * merged["åœ¨åº«ç¶­æŒæœˆæ•°"]

    # 8) ä¸­é–“å½¢
    # ğŸ”´ ã“ã“ã§ å“åãƒ»æ³•ä»¤ãƒ»ä¿ç®¡å½¢æ…‹ãƒ»å€‰åº«æ©Ÿèƒ½ ã‚‚æ®‹ã™ã‚ˆã†ã«ä¿®æ­£
    result = (
        merged[
            [
                "è­˜åˆ¥å­",
                "å¹´æœˆ",
                "ç¹å¿™åº¦",
                "è²©å£²æ•°é‡",
                "åœ¨åº«ç¶­æŒæœˆæ•°",
                "åœ¨åº«æ•°é‡",
                "å“å",
                "æ³•ä»¤",
                "ä¿ç®¡å½¢æ…‹",
                "å€‰åº«æ©Ÿèƒ½",
            ]
        ]
        .sort_values(["è­˜åˆ¥å­", "å¹´æœˆ"])
        .reset_index(drop=True)
    )

    # 9) PLæ›ç®—ãƒã‚¹ã‚¿ï¼ˆplchange_dfï¼‰ã‚’ãƒãƒ¼ã‚¸
    result = result.merge(
        plchange_df[["è­˜åˆ¥å­", "é‡é‡æ¡ˆåˆ†å¾ŒPLæ›ç®—ä¿‚æ•°"]],
        on="è­˜åˆ¥å­",
        how="left",
    )

    # å¿µã®ãŸã‚æ•°å€¤åŒ–
    result["é‡é‡æ¡ˆåˆ†å¾ŒPLæ›ç®—ä¿‚æ•°"] = pd.to_numeric(
        result["é‡é‡æ¡ˆåˆ†å¾ŒPLæ›ç®—ä¿‚æ•°"], errors="coerce"
    )

    # 10) åœ¨åº«æ•°é‡(t) / åœ¨åº«æ•°é‡(pl) ã‚’è¨ˆç®—
    result["åœ¨åº«æ•°é‡(t)"] = result["åœ¨åº«æ•°é‡"]
    result["åœ¨åº«æ•°é‡(pl)"] = (
        result["åœ¨åº«æ•°é‡(t)"] * result["é‡é‡æ¡ˆåˆ†å¾ŒPLæ›ç®—ä¿‚æ•°"]
    )

    # 11) ã‚«ãƒ©ãƒ æ•´ç†
    # æœ€çµ‚å‡ºåŠ›ã«ã‚‚ å“åãƒ»æ³•ä»¤ãƒ»ä¿ç®¡å½¢æ…‹ãƒ»å€‰åº«æ©Ÿèƒ½ ã‚’å«ã‚ã‚‹
    result = (
        result[
            [
                "è­˜åˆ¥å­",
                "å“å",
                "æ³•ä»¤",
                "ä¿ç®¡å½¢æ…‹",
                "å€‰åº«æ©Ÿèƒ½",
                "å¹´æœˆ",
                "ç¹å¿™åº¦",
                "è²©å£²æ•°é‡",
                "åœ¨åº«ç¶­æŒæœˆæ•°",
                "åœ¨åº«æ•°é‡(t)",
                "é‡é‡æ¡ˆåˆ†å¾ŒPLæ›ç®—ä¿‚æ•°",
                "åœ¨åº«æ•°é‡(pl)",
            ]
        ]
        .sort_values(["è­˜åˆ¥å­", "å¹´æœˆ"])
        .reset_index(drop=True)
    )

    # 12) å°æ•°ç‚¹2æ¡ã«ä¸¸ã‚ã‚‹
    for col in ["è²©å£²æ•°é‡", "åœ¨åº«ç¶­æŒæœˆæ•°", "åœ¨åº«æ•°é‡(t)", "åœ¨åº«æ•°é‡(pl)"]:
        result[col] = result[col].round(2)

    return result
